import pandas as pd
from datetime import datetime

from data_engine.price_data import get_price_data
from feature_engine.technical_features import add_technical_features
from scoring_engine.scoring_model import calculate_score
from delivery_engine.telegram_alert import send_alert

# ==============================
# ğŸ“Š STOCK LIST
# ==============================

STOCKS = [
    "RELIANCE.NS",
    "TCS.NS",
    "INFY.NS",
    "HDFCBANK.NS",
    "ICICIBANK.NS",
    "LT.NS",
    "SBIN.NS",
    "AXISBANK.NS",
    "KOTAKBANK.NS",
    "ITC.NS"
]

# ==============================
# ğŸ“© PROFESSIONAL TELEGRAM FORMATTER
# ==============================

def format_telegram_output(top_df):

    now_time = datetime.now().strftime("%d-%m-%Y %H:%M")

    message = f"ğŸ“Š *NSE Swing Scanner Report*\n"
    message += f"â° {now_time}\n"
    message += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"

    rank = 1

    for _, row in top_df.iterrows():

        emoji = "ğŸŸ¢" if row["Trend"] == "Bullish" else "ğŸ”´"

        message += f"""
{rank}. {emoji} *{row['Stock']}*
   ğŸ“ˆ Score : *{row['Score']}/100*
   ğŸ“Š Trend : {row['Trend']}
   âš¡ RSI   : {row['RSI']}
   ğŸ”¥ ATR   : {row['ATR']}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
        rank += 1

    message += "\nğŸ” Filter: Technical Ranking Engine"
    message += "\n#AI_Swing_System ğŸš€"

    return message

# ==============================
# ğŸš€ MAIN EXECUTION
# ==============================

def main():

    results = []

    print("ğŸ”„ Scanner Started...")

    for stock in STOCKS:

        print(f"Scanning {stock}...")

        df = get_price_data(stock)

        if df is None or df.empty:
            print(f"âŒ No data for {stock}, skipping.")
            continue

        df = add_technical_features(df)

        result = calculate_score(stock, df)

        if result:
            results.append(result)

    if not results:
        print("âŒ No valid stocks found.")
        return

    df_results = pd.DataFrame(results)

    df_results = df_results.sort_values(by="Score", ascending=False)

    top5 = df_results.head(5)

    print("\nğŸ”¥ TOP 5 STOCKS ğŸ”¥")
    print(top5)

    # ==============================
    # ğŸ“© TELEGRAM SEND
    # ==============================

    telegram_message = format_telegram_output(top5)

    send_alert(telegram_message)

    print("âœ… Telegram Alerts Sent Successfully!")


if __name__ == "__main__":
    main()
